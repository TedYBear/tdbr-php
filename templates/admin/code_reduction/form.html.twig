{% extends 'admin/base_admin.html.twig' %}

{% block title %}{{ code ? 'Modifier' : 'Nouveau' }} code de réduction{% endblock %}
{% block page_title %}{{ code ? 'Modifier' : 'Nouveau' }} code de réduction{% endblock %}

{% block body %}
<div class="max-w-xl">
    <form method="post" class="space-y-6">

        <div class="card p-6 space-y-5">

            <div class="form-group">
                <label>Code *</label>
                <input type="text" name="code"
                       value="{{ code ? code.code : '' }}"
                       required class="form-input font-mono uppercase"
                       placeholder="Ex: MERCI10, BIENVENUE5..."
                       oninput="this.value = this.value.toUpperCase()">
                <p class="text-xs text-gray-500 mt-1">Identifiant visible par l'utilisateur.</p>
            </div>

            <div class="form-group">
                <label>Montant de la réduction (€) *</label>
                <input type="number" name="montant" step="0.01" min="0.01"
                       value="{{ code ? code.montant : '' }}"
                       required class="form-input"
                       placeholder="Ex: 10.00">
            </div>

            <div class="form-group">
                <label>Type de code</label>
                <select name="type" class="form-select" onchange="toggleUserField(this.value)">
                    <option value="global" {{ (not code or code.isGlobal) ? 'selected' : '' }}>Global — valable pour tous les utilisateurs</option>
                    <option value="user" {{ (code and not code.isGlobal) ? 'selected' : '' }}>Spécifique à un utilisateur</option>
                </select>
            </div>

            <div class="form-group" id="userField" style="{{ (code and not code.isGlobal) ? '' : 'display:none' }}">
                <label>Utilisateur</label>
                <select name="userId" class="form-select">
                    <option value="">-- Choisir un utilisateur --</option>
                    {% for user in users %}
                        <option value="{{ user.id }}"
                            {% if code and not code.isGlobal and code.user.id == user.id %}selected{% endif %}>
                            {{ user.email }}{% if user.fullName %} — {{ user.fullName }}{% endif %}
                        </option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>Date de début</label>
                <input type="date" name="dateDebut"
                       value="{{ code and code.dateDebut ? code.dateDebut|date('Y-m-d') : '' }}"
                       class="form-input">
                <p class="text-xs text-gray-500 mt-1">Laisser vide pour que le code soit actif immédiatement.</p>
            </div>

            <div class="form-group">
                <label>Date d'expiration</label>
                <input type="date" name="dateExpiration"
                       value="{{ code and code.dateExpiration ? code.dateExpiration|date('Y-m-d') : '' }}"
                       class="form-input">
                <p class="text-xs text-gray-500 mt-1">Laisser vide pour un code sans expiration.</p>
            </div>

            <div class="form-group">
                <label>Statut</label>
                <select name="statut" class="form-select">
                    <option value="actif" {{ (not code or code.statut == 'actif') ? 'selected' : '' }}>Actif</option>
                    <option value="utilise" {{ (code and code.statut == 'utilise') ? 'selected' : '' }}>Utilisé</option>
                </select>
            </div>

        </div>

        <div class="flex gap-3">
            <button type="submit" class="btn-primary">
                {{ code ? 'Mettre à jour' : 'Créer le code' }}
            </button>
            <a href="{{ path('admin_codes_reduction') }}" class="btn-outline">
                Annuler
            </a>
        </div>

    </form>
</div>

<script>
function toggleUserField(type) {
    document.getElementById('userField').style.display = type === 'user' ? '' : 'none';
}
</script>
{% endblock %}
