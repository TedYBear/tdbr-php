{#
  Composant upload d'une image unique
  Variables attendues :
  - fieldName : nom du champ hidden (ex: 'image')
  - currentImage : URL de l'image actuelle (optionnel)
  - directory : sous-dossier upload (ex: 'categories')
  - label : label affiché (optionnel)
#}
{% set _label = label ?? 'Image' %}
{% set _directory = directory ?? 'articles' %}

<div x-data="{
    imageUrl: '{{ currentImage ?? '' }}',
    uploading: false,
    error: '',
    async handleFile(file) {
        if (!file || !file.type.startsWith('image/')) { this.error = 'Fichier invalide'; return; }
        if (file.size > 5242880) { this.error = 'Taille max : 5 Mo'; return; }
        this.error = '';
        this.uploading = true;
        const fd = new FormData();
        fd.append('file', file);
        try {
            const r = await fetch('/admin/upload/image?dir={{ _directory }}', { method: 'POST', body: fd });
            const text = await r.text();
            let d;
            try { d = JSON.parse(text); } catch { this.error = 'Réponse invalide (' + r.status + ')'; this.uploading = false; return; }
            if (d.success) { this.imageUrl = d.path; }
            else { this.error = d.error || 'Erreur upload'; }
        } catch(e) { this.error = 'Erreur réseau : ' + e.message; }
        this.uploading = false;
    },
    onDrop(e) { e.preventDefault(); this.handleFile(e.dataTransfer.files[0]); },
    removeImage() { this.imageUrl = ''; }
}">
    <label class="block text-sm font-medium text-gray-700 mb-1">{{ _label }}</label>

    <input type="hidden" name="{{ fieldName }}" :value="imageUrl">

    {# Zone upload #}
    <div x-show="!imageUrl"
         @dragover.prevent
         @drop="onDrop($event)"
         @click="$refs.fileInput.click()"
         class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer hover:border-primary hover:bg-primary/5 transition-colors">
        <svg class="w-8 h-8 mx-auto text-gray-400 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
        </svg>
        <p class="text-sm text-gray-500" x-show="!uploading">Glissez une image ou cliquez pour sélectionner</p>
        <p class="text-sm text-primary font-medium" x-show="uploading">Envoi en cours...</p>
        <input type="file" x-ref="fileInput" accept="image/*" class="hidden"
               @change="handleFile($event.target.files[0]); $event.target.value=''">
    </div>

    {# Preview #}
    <div x-show="imageUrl" class="relative inline-block">
        <img :src="imageUrl" alt="Preview" class="w-full max-h-64 object-contain rounded-xl border border-gray-200">
        <button type="button" @click="removeImage()"
                class="absolute top-2 right-2 bg-red-500 text-white rounded-full w-7 h-7 flex items-center justify-center hover:bg-red-600 shadow">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
            </svg>
        </button>
        <button type="button" @click="imageUrl=''; $nextTick(() => $refs.fileInput2.click())"
                class="mt-2 text-sm text-primary hover:underline block">Changer l'image</button>
        <input type="file" x-ref="fileInput2" accept="image/*" class="hidden"
               @change="handleFile($event.target.files[0]); $event.target.value=''">
    </div>

    <p x-show="error" x-text="error" class="text-sm text-red-600 mt-1"></p>
</div>
